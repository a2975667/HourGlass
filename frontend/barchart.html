<!DOCTYPE html>
<meta charset="utf-8">
	<link rel="stylesheet" href="css/style.css" type="text/css" />
	<style>
	</style>
	<body>
		<div id="nav">
	    <h1>HourGlass</h1>
	  </div>
		<div id="container">
	    <h2>Weekly Overview</h2>
			<div id="d3id" ></div>
			<h3>Progress</h3>
			<p id="goalMet">0</p>
			<p id="highest">0</p>
			<p id="average">0</p>
			<p id="lowest">0</p>
	  </div>

		<script src="https://d3js.org/d3.v4.min.js"></script>

		<script>
		// current data assumptions: current string tags are start dates to a week. (only titular, does not matter)
		// The numbers for distraction goals and actual distraction for each week are put into the same entry.
		// Every entry has a date tag, a goal, and a distraction count. Undefined goals should be 0.

		var data = [
		  {
		    "tag":"2018-10-29",
		    "distractions":184,
		    "goal":98
		  },
		  {
		    "tag":"2018-11-5",
				"distractions":87,
		    "goal":98
		  },
		  {
		    "tag":"2018-11-12",
				"distractions":65,
		    "goal":112
		  }
		];

		var container = d3.select('#d3id'),
		    width = 750,
		    height = 400,
		    margin = {top: 30, right: 20, bottom: 30, left: 50},
		    barPadding = .2,
		    axisTicks = {qty: 5, outerSize: 0, dateFormat: '%m-%d'};

		var svg = container
		   .append("svg")
		   .attr("width", width)
		   .attr("height", height)
		   .append("g")
		   .attr("transform", `translate(${margin.left},${margin.top})`);

		// set up scales:
		var xScale0 = d3.scaleBand().range([0, width - margin.left - margin.right]).padding(barPadding);
		var xScale1 = d3.scaleBand();
		var yScale = d3.scaleLinear().range([height - margin.top - margin.bottom, 0]);

		// set up axis:
		var xAxis = d3.axisBottom(xScale0)
				.tickSizeOuter(axisTicks.outerSize);
		var yAxis = d3.axisLeft(yScale)
				.tickSizeOuter(axisTicks.outerSize);

		// set scales:
		xScale0.domain(data.map(d => d.tag));
		xScale1.domain(['distractions', 'goal']).range([0, xScale0.bandwidth()]);
		yScale.domain([0, d3.max(data, d => d.distractions > d.goal ? d.distractions : d.goal)]);

		var tag = svg.selectAll(".tag")
		  .data(data)
		  .enter().append("g")
		  .attr("class", "tag")
		  .attr("transform", d => `translate(${xScale0(d.tag)},0)`);

		tag.selectAll(".bar.distractions")
		  .data(d => [d])
		  .enter()
		  .append("rect")
		  .attr("class", "bar distractions")
		.style("fill", function(d) {
				if (d.distractions < d.goal) {
					return "#5f66fb";
				} else {
					return "#fc585a";
				}
			})
		  .attr("x", d => xScale1('distractions'))
		  .attr("y", d => yScale(d.distractions))
		  .attr("width", xScale1.bandwidth())
		  .attr("height", d => {
		    return height - margin.top - margin.bottom - yScale(d.distractions)
		  });

		tag.selectAll(".bar.goal")
		  .data(d => [d])
		  .enter()
		  .append("rect")
		  .attr("class", "bar goal")
		.style("fill", "#fec95a")
		  .attr("x", d => xScale1('goal'))
		  .attr("y", d => yScale(d.goal))
		  .attr("width", (xScale1.bandwidth() / 8))
		  .attr("height", d => {
		    return height - margin.top - margin.bottom - yScale(d.goal)
		  });

		svg.append("g")
		   .attr("class", "x axis")
		   .attr("transform", `translate(0,${height - margin.top - margin.bottom})`)
		   .call(xAxis);

		svg.append("g")
		   .attr("class", "y axis")
		   .call(yAxis);

		// TODO: legend

		// progress statistics
		function getDistractions() {
  		return data.map(d => d.distractions);
		}

		function getGoals() {
			return data.map(d => d.goal);
		}

		function getMin() {
  		return Math.min(...getDistractions());
		}

		function getMax() {
  		return Math.max(...getDistractions());
		}

		function getAvg() {
			var dist = getDistractions();
			var total = 0;

			for (var i = 0; i < dist.length; i++) {
				total += dist[i];
			}

			return (total / dist.length);
		}

		function getGoalsMet() {
			var dist = getDistractions();
			var goals = getGoals();
			var total = 0;

			for (var i = 0; (i < dist.length) && (i < goals.length); i++) {
				if (dist[i] < goals[i]) {
					total += 1;
				}
			}

			return total;
		}

		document.getElementById("goalMet").innerHTML = getGoalsMet();
		document.getElementById("highest").innerHTML = getMax();
		document.getElementById("lowest").innerHTML = getMin();
		document.getElementById("average").innerHTML = getAvg();
	</script>
</body>
